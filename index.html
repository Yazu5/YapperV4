<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Yapper Pro</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://meet.jit.si/external_api.js"></script>
    <style>
        :root {
            --imessage-blue: linear-gradient(180deg, #00D2FF 0%, #007AFF 100%);
            --bg-main: #ffffff; --text-dark: #000000; --text-gray: #8E8E93;
            --bubble-received: #E9E9EB; --border: #C6C6C8;
            --ios-font: -apple-system, BlinkMacSystemFont, "SF Pro Display", sans-serif;
        }
        [data-theme="dark"] {
            --bg-main: #000000; --text-dark: #ffffff; --text-gray: #98989D;
            --bubble-received: #1C1C1E; --border: #38383A;
        }

        * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin: 0; padding: 0; }
        body, html { height: 100dvh; width: 100vw; font-family: var(--ios-font); background: var(--bg-main); color: var(--text-dark); overflow: hidden; }
        
        /* Views */
        .view { display: none; flex-direction: column; height: 100%; width: 100%; background: var(--bg-main); position: relative; z-index: 1; }
        
        /* Overlays - FIXED: Display none ensures they don't block clicks */
        #call-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: black; z-index: 9999; display: none; }
        #reaction-menu { position: fixed; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); border-radius: 20px; padding: 12px; display: none; flex-direction: column; gap: 12px; z-index: 2000; box-shadow: 0 8px 30px rgba(0,0,0,0.3); }

        /* Full Space UI */
        .header { padding: env(safe-area-inset-top) 20px 10px; display: flex; align-items: center; justify-content: space-between; border-bottom: 0.5px solid var(--border); min-height: 85px; background: var(--bg-main); }
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .msg-row { display: flex; width: 100%; position: relative; margin-bottom: 2px; }
        .msg-row.sent { justify-content: flex-end; }
        .msg { max-width: 85%; padding: 12px 18px; border-radius: 22px; font-size: 17px; line-height: 1.4; position: relative; cursor: pointer; }
        .sent .msg { background: var(--imessage-blue); color: white; border-bottom-right-radius: 4px; }
        .received .msg { background: var(--bubble-received); color: var(--text-dark); border-bottom-left-radius: 4px; }

        #input-area { padding: 10px 20px calc(15px + env(safe-area-inset-bottom)); display: flex; gap: 12px; border-top: 0.5px solid var(--border); background: var(--bg-main); width: 100%; }
        #msg-input { flex: 1; border: none; background: var(--bubble-received); color: var(--text-dark); padding: 14px 20px; border-radius: 25px; font-size: 16px; outline: none; user-select: text; }

        /* Auth styling */
        .auth-container { padding: 40px; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; width: 100%; }
        .auth-content { width: 100%; max-width: 400px; text-align: center; }
        .auth-input { width: 100%; padding: 16px; margin-bottom: 12px; border-radius: 12px; border: 1px solid var(--border); background: transparent; color: var(--text-dark); font-size: 16px; user-select: text; }
        .blue-btn { background: #007AFF; color: white; border: none; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 17px; cursor: pointer; width: 100%; }
    </style>
</head>
<body data-theme="dark">

    <audio id="ringtone" loop src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3"></audio>

    <div id="call-overlay">
        <div id="jitsi-container" style="height: 100%; width: 100%;"></div>
        <button onclick="endCall()" style="position:absolute; bottom:60px; left:50%; transform:translateX(-50%); background:#FF3B30; color:white; border:none; padding:18px 45px; border-radius:40px; font-weight:bold; z-index:10001;">End Call</button>
    </div>

    <div id="auth-view" class="view" style="display:flex;">
        <div class="auth-container">
            <div class="auth-content">
                <h1 id="auth-title" style="font-size: 48px; margin-bottom: 30px;">Yapper</h1>
                <input type="email" id="email" class="auth-input" placeholder="Email">
                <input type="password" id="password" class="auth-input" placeholder="Password">
                <button id="login-trigger" onclick="handleAuth()" class="blue-btn">Log In</button>
                <p onclick="toggleAuthMode()" id="toggle-text" style="color:#007AFF; margin-top:25px; cursor:pointer;">New? Sign Up</p>
            </div>
        </div>
    </div>

    <div id="home-view" class="view">
        <div class="header">
            <button onclick="toggleDarkMode()" style="background:none; border:none; font-size:24px;">ðŸŒ“</button>
            <div style="font-weight:700; font-size:26px;">Messages</div>
            <button onclick="logout()" style="background:none; border:none; color:#FF3B30; font-size:16px;">Logout</button>
        </div>
        <div id="friend-list" style="overflow-y:auto; flex:1;"></div>
    </div>

    <div id="chat-view" class="view">
        <div class="header">
            <button onclick="goHome()" style="background:none; border:none; color:#007AFF; font-size:18px;">â€¹ Back</button>
            <div id="chat-target-name" style="font-weight:700;">...</div>
            <div style="display:flex; gap:15px;">
                <button onclick="startCall('voice')" style="background:none; border:none; font-size:22px;">ðŸ“ž</button>
                <button onclick="startCall('video')" style="background:none; border:none; font-size:22px;">ðŸ“¹</button>
            </div>
        </div>
        <div id="messages"></div>
        <div id="input-area">
            <input type="text" id="msg-input" placeholder="Yapper">
            <button onclick="sendMessage()" style="background:#007AFF; color:white; border:none; width:44px; height:44px; border-radius:50%; font-weight:bold;">â†‘</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";

        const firebaseConfig = { apiKey: "AIzaSyB98LWEjfYaG_wbkMkwo0QJ4ch8VhQO-IA", authDomain: "messengerapp-dcccc.firebaseapp.com", projectId: "messengerapp-dcccc", storageBucket: "messengerapp-dcccc.firebasestorage.app", messagingSenderId: "255835922798", appId: "1:255835922798:web:d9293fc275ae2b18fa617f" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app); const auth = getAuth(app);
        
        let activeChatId = null; let isSignUp = false; let jitsiApi = null;
        const ringtone = document.getElementById('ringtone');

        onAuthStateChanged(auth, user => {
            if (user) { switchView('home-view'); } 
            else { switchView('auth-view'); }
        });

        window.handleAuth = () => {
            const e = document.getElementById('email').value, p = document.getElementById('password').value;
            if(!e || !p) return alert("Enter details");
            const btn = document.getElementById('login-trigger');
            btn.disabled = true; btn.innerText = "Connecting...";

            if(isSignUp) {
                createUserWithEmailAndPassword(auth, e, p).then(c => {
                    setDoc(doc(db, "users", c.user.uid), { nickname: e.split('@')[0], uid: c.user.uid });
                }).catch(err => alert(err.message));
            } else {
                signInWithEmailAndPassword(auth, e, p).catch(err => { alert(err.message); btn.disabled = false; btn.innerText = "Log In"; });
            }
        };

        window.startCall = (type) => {
            ringtone.play();
            document.getElementById('call-overlay').style.display = 'block';
            jitsiApi = new JitsiMeetExternalAPI("meet.jit.si", {
                roomName: "Yapper_" + activeChatId, width: "100%", height: "100%",
                parentNode: document.querySelector('#jitsi-container'),
                configOverwrite: { startWithVideoMuted: type === 'voice', prejoinPageEnabled: false }
            });
            jitsiApi.addEventListener('videoConferenceJoined', () => { ringtone.pause(); ringtone.currentTime = 0; });
        };

        window.endCall = () => {
            ringtone.pause(); if(jitsiApi) jitsiApi.dispose();
            document.getElementById('call-overlay').style.display = 'none';
        };

        window.switchView = (id) => {
            document.querySelectorAll('.view').forEach(v => v.style.display='none');
            document.getElementById(id).style.display = 'flex';
        };
        window.toggleAuthMode = () => { isSignUp = !isSignUp; document.getElementById('auth-title').innerText = isSignUp ? "Sign Up" : "Yapper"; document.getElementById('login-trigger').innerText = isSignUp ? "Create Account" : "Log In"; };
        window.goHome = () => switchView('home-view');
        window.logout = () => signOut(auth);
    </script>
</body>
</html>
